<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>世界足跡地圖</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🌍</text></svg>">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/map.css?v=1.2">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-9H225N2CYJ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-9H225N2CYJ');
    </script>
</head>
<body>

    <header class="main-header">
        <h1 id="page-title" class="page-title">讀取中...</h1>
        <a href="index.html" class="home-link">&larr; 返回首頁</a>
    </header>

    <main id="main-content">
        <div id="container">
            <div id="map"></div>
            <div id="info-panel">
                <div id="info-panel-header">
                    <div id="stats">
                        <p>國家總數: <span id="country-count">0</span></p>
                        <p>地點總數: <span id="location-count">0</span></p>
                    </div>
                    <div id="social-links-container"></div>
                </div>
                <div id="yearly-list-container">
                    <div id="yearly-list">
                        <!-- Yearly data will be populated here -->
                    </div>
                    <div id="loader" class="loader">
                        <p>讀取中...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const map = L.map('map').setView([25, 121], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            const pageTitleEl = document.getElementById('page-title');
            const countryCountEl = document.getElementById('country-count');
            const locationCountEl = document.getElementById('location-count');
            const yearlyListEl = document.getElementById('yearly-list');
            const loaderEl = document.getElementById('loader');
            const socialLinksContainer = document.getElementById('social-links-container');
            
            const markers = L.markerClusterGroup({ 
                maxClusterRadius: 1 // Only cluster markers at the same exact position
            });

            fetch('travel_data.json', { cache: 'no-store' }) // Prevent caching issues
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // --- Process Social Links ---
                    if (data.social_links && Array.isArray(data.social_links) && socialLinksContainer) {
                        data.social_links.forEach(link => {
                            const a = document.createElement('a');
                            a.href = link.url;
                            a.target = '_blank'; // Open in new tab
                            a.rel = 'noopener noreferrer';
                            a.className = 'social-link';
                            a.title = link.name; // Tooltip
                            a.innerHTML = `<i class="${link.icon}"></i> <span>${link.name}</span>`;
                            socialLinksContainer.appendChild(a);
                        });
                    }

                    // --- Process Map Data ---
                    const locations = Array.isArray(data) ? data : (data && data.locations);

                    if (!Array.isArray(locations)) {
                        throw new Error("JSON data is not in the expected format.");
                    }

                    const pageTitle = (data && data.title) || '陳主惠和鄭亞薇的世界足跡';

                    document.title = pageTitle;
                    pageTitleEl.textContent = pageTitle;
                    locationCountEl.textContent = locations.length;

                    const yearlyData = {};
                    const countrySet = new Set();

                    locations.forEach(loc => {
                        if (!loc || typeof loc !== 'object') return; // Skip invalid entries

                        if (loc.year && loc.place) {
                            if (!yearlyData[loc.year]) {
                                yearlyData[loc.year] = [];
                            }
                            yearlyData[loc.year].push(loc.place);
                        }

                        if (loc.country) {
                            countrySet.add(loc.country);
                        }

                        if (loc.lat != null && loc.lon != null) {
                            const marker = L.marker([loc.lat, loc.lon])
                                .bindPopup(`<b>${loc.year}</b><br>${loc.place}`);
                            markers.addLayer(marker);
                        }
                    });

                    map.addLayer(markers);
                    countryCountEl.textContent = countrySet.size;

                    const sortedYears = Object.keys(yearlyData).sort((a, b) => b - a);

                    yearlyListEl.innerHTML = ''; // Clear previous content
                    sortedYears.forEach(year => {
                        const yearHeader = document.createElement('h2');
                        yearHeader.textContent = `${year}年`;
                        const placeList = document.createElement('ul');
                        yearlyData[year].forEach(place => {
                            const listItem = document.createElement('li');
                            listItem.textContent = place;
                            placeList.appendChild(listItem);
                        });
                        yearlyListEl.appendChild(yearHeader);
                        yearlyListEl.appendChild(placeList);
                    });

                    if(loaderEl) loaderEl.style.display = 'none';

                })
                .catch(error => {
                    console.error('Error processing data:', error);
                    pageTitleEl.textContent = '錯誤';
                    const infoPanel = document.getElementById('info-panel');
                    infoPanel.innerHTML = `<p style='color:red; padding: 20px;'>資料載入失敗: ${error.message}</p>`;
                });
        });
    </script>

</body>
</html>