<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰∏ñÁïåË∂≥Ë∑°Âú∞Âúñ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåç</text></svg>">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            background-color: #f0f2f5; /* A slightly grey background */
        }
        body {
            display: flex;
            flex-direction: column;
        }
        .main-header {
            text-align: center;
            padding: 1rem;
            background-color: #ffffff;
            border-bottom: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            flex-shrink: 0; /* Prevent header from shrinking */
        }
        .main-header h1 {
            margin: 0;
            font-size: 1.8rem;
        }
        .home-link {
            display: inline-block;
            margin-top: 1rem;
            color: #3498db;
            text-decoration: none;
            font-size: 1rem;
        }
        .home-link:hover {
            text-decoration: underline;
        }
        #main-content {
            flex-grow: 1;
            padding: 1rem;
            overflow: hidden; /* Prevent scrollbars on the main content itself */
        }
        #container {
            display: flex;
            flex-direction: row;
            height: 100%;
            gap: 1rem; /* Add space between map and info panel */
        }
        #map, #info-panel {
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 1px solid #dee2e6;
        }
        #map {
            height: 100%;
            width: 70%;
        }
        #info-panel {
            width: 30%;
            height: 100%;
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
            background-color: #ffffff;
        }
        #stats {
            margin-bottom: 20px;
            font-size: 1rem;
            border-bottom: 1px solid #ccc;
            padding-bottom: 15px;
        }
        #stats p {
            margin: 5px 0;
        }
        #yearly-list h2 {
            font-size: 1.2rem;
            margin-top: 20px;
            color: #007bff;
        }
        #yearly-list ul {
            list-style-type: none;
            padding-left: 10px;
        }
        #yearly-list li {
            margin-bottom: 5px;
        }
        .loader {
            padding: 20px;
            text-align: center;
            font-style: italic;
            color: #6c757d;
        }

        /* Responsive Design for mobile devices */
        @media (max-width: 768px) {
            .main-header h1 {
                font-size: 1.5rem;
            }
            .home-link {
                padding: 10px 16px;
                font-size: 1.1rem;
                background-color: #007bff;
                color: white;
                border-radius: 5px;
            }
            .home-link:hover {
                text-decoration: none;
                background-color: #0056b3;
            }
            #main-content {
                padding: 0.5rem;
            }
            #container {
                flex-direction: column;
                gap: 0.5rem;
            }
            #map {
                width: 100%;
                height: 45%; /* Adjust height for mobile */
            }
            #info-panel {
                width: 100%;
                height: 55%; /* Adjust height for mobile */
            }
        }
    </style>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-9H225N2CYJ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-9H225N2CYJ');
    </script>
</head>
<body>

    <header class="main-header">
        <h1 id="page-title">ËÆÄÂèñ‰∏≠...</h1>
        <a href="index.html" class="home-link">&larr; ËøîÂõûÈ¶ñÈ†Å</a>
    </header>

    <main id="main-content">
        <div id="container">
            <div id="map"></div>
            <div id="info-panel">
                <div id="stats">
                    <p>ÂúãÂÆ∂Á∏ΩÊï∏: <span id="country-count">0</span></p>
                    <p>Âú∞ÈªûÁ∏ΩÊï∏: <span id="location-count">0</span></p>
                </div>
                <div id="yearly-list">
                    <!-- Yearly data will be populated here -->
                </div>
                <div id="loader" class="loader">
                    <p>ËÆÄÂèñ‰∏≠...</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const map = L.map('map').setView([25, 121], 2);
            L.tileLayer('https://maps.wikimedia.org/osm-intl/{z}/{x}/{y}.png?lang=zh-tw', {
                maxZoom: 18,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            const pageTitleEl = document.getElementById('page-title');
            const countryCountEl = document.getElementById('country-count');
            const locationCountEl = document.getElementById('location-count');
            const yearlyListEl = document.getElementById('yearly-list');
            const loaderEl = document.getElementById('loader');
            
            const markers = L.markerClusterGroup({ 
                maxClusterRadius: 1 // Only cluster markers at the same exact position
            });

            fetch('travel_data.json', { cache: 'no-store' }) // Prevent caching issues
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const locations = Array.isArray(data) ? data : (data && data.locations);

                    if (!Array.isArray(locations)) {
                        throw new Error("JSON data is not in the expected format.");
                    }

                    const pageTitle = (data && data.title) || 'Èô≥‰∏ªÊÉ†ÂíåÈÑ≠‰∫ûËñáÁöÑ‰∏ñÁïåË∂≥Ë∑°';

                    document.title = pageTitle;
                    pageTitleEl.textContent = pageTitle;
                    locationCountEl.textContent = locations.length;

                    const yearlyData = {};
                    const countrySet = new Set();

                    locations.forEach(loc => {
                        if (!loc || typeof loc !== 'object') return; // Skip invalid entries

                        if (loc.year && loc.place) {
                            if (!yearlyData[loc.year]) {
                                yearlyData[loc.year] = [];
                            }
                            yearlyData[loc.year].push(loc.place);
                        }

                        if (loc.country) {
                            countrySet.add(loc.country);
                        }

                        if (loc.lat != null && loc.lon != null) {
                            const marker = L.marker([loc.lat, loc.lon])
                                .bindPopup(`<b>${loc.year}</b><br>${loc.place}`);
                            markers.addLayer(marker);
                        }
                    });

                    map.addLayer(markers);
                    countryCountEl.textContent = countrySet.size;

                    const sortedYears = Object.keys(yearlyData).sort((a, b) => b - a);

                    yearlyListEl.innerHTML = ''; // Clear previous content
                    sortedYears.forEach(year => {
                        const yearHeader = document.createElement('h2');
                        yearHeader.textContent = `${year}Âπ¥`;
                        const placeList = document.createElement('ul');
                        yearlyData[year].forEach(place => {
                            const listItem = document.createElement('li');
                            listItem.textContent = place;
                            placeList.appendChild(listItem);
                        });
                        yearlyListEl.appendChild(yearHeader);
                        yearlyListEl.appendChild(placeList);
                    });

                    if(loaderEl) loaderEl.style.display = 'none';

                })
                .catch(error => {
                    console.error('Error processing data:', error);
                    pageTitleEl.textContent = 'ÈåØË™§';
                    const infoPanel = document.getElementById('info-panel');
                    infoPanel.innerHTML = `<p style='color:red; padding: 20px;'>Ë≥áÊñôËºâÂÖ•Â§±Êïó: ${error.message}</p>`;
                });
        });
    </script>

</body>
</html>