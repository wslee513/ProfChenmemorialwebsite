<!DOCTYPE html>
<html>
<head>
  <title>旅遊足跡地圖</title>
  <meta charset="UTF-8">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: #f4f4f9;
    }
    .header {
      text-align: center;
      padding: 10px 20px;
      background-color: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }
    h1 {
      color: #2c3e50;
      margin: 0;
    }
    .home-link {
      position: absolute;
      left: 20px;
      font-size: 1rem;
      color: #3498db;
      text-decoration: none;
    }
    .home-link:hover {
      text-decoration: underline;
    }
    #main-container {
      display: flex;
      width: 95%;
      max-width: 1600px;
      margin: 20px auto;
      gap: 20px;
    }
    #map-container {
      flex: 3;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    #map {
      height: 78vh;
      width: 100%;
      border-radius: 5px;
    }
    #info-panel {
      flex: 1;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      height: calc(78vh + 40px); /* Match map container height */
      overflow-y: auto;
    }
    #info-panel h2 {
      color: #34495e;
      border-bottom: 2px solid #ecf0f1;
      padding-bottom: 10px;
      margin-top: 0;
    }
    #info-panel h3 {
      color: #e67e22;
    }
    #yearly-list ul {
      list-style-type: none;
      padding-left: 5px;
    }
    #yearly-list li {
      margin-bottom: 5px;
      color: #333;
    }
    #tooltip {
      display: none;
      position: absolute;
      background: white;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 1000;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div class="header">
    <a href="index.html" class="home-link">&larr; 返回首頁</a>
    <h1>陳主惠和鄭亞薇的世界地圖</h1>
  </div>
  <div id="main-container">
    <div id="map-container">
      <div id="map"></div>
    </div>
    <div id="info-panel">
      <div id="summary"></div>
      <div id="yearly-list"></div>
    </div>
  </div>
  <div id="tooltip"></div>
  <script>
    let currentOpenTooltip = null;
    let currentOpenMarker = null;

    // Main function to initialize the map and load data
    async function initialize() {
      try {
        const response = await fetch('travel_data.json');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const travelData = await response.json();
        
        // Populate the info panel with statistics and lists
        updateInfoPanel(travelData);

        // Initialize the map
        const map = new google.maps.Map(document.getElementById('map'), {
          zoom: 2,
          center: {lat: 30, lng: 50},
        });

        // Close any open tooltip when the map is clicked
        map.addListener('click', () => {
          if (currentOpenTooltip) {
            currentOpenTooltip.style.display = 'none';
            currentOpenTooltip = null;
            currentOpenMarker = null;
          }
        });

        const geocoder = new google.maps.Geocoder();

        // Add markers to the map
        travelData.forEach(item => {
          geocodePlace(geocoder, map, item);
        });

      } catch (error) {
        console.error("Could not load travel data:", error);
        document.getElementById('info-panel').innerHTML = "<p>資料載入失敗，請稍後再試。</p>";
      }
    }

    function updateInfoPanel(travelData) {
      // Calculate total unique places
      const uniquePlaces = new Set(travelData.map(item => item.place));
      const totalLocations = uniquePlaces.size;

      // Calculate total unique countries (heuristic)
      const nonCountries = new Set(['高加索地區', '南極洲', '南太平洋', '中國絲路', '婆羅洲', '格陵蘭', '關島']);
      const countrySet = new Set();
      const countryPrefixes = ['中國', '俄羅斯', '菲律賓', '馬來西亞', '日本', '印度', '美國', '印尼'];

      uniquePlaces.forEach(place => {
        if (nonCountries.has(place)) return;

        let countryFound = false;
        for (const prefix of countryPrefixes) {
          if (place.startsWith(prefix)) {
            countrySet.add(prefix);
            countryFound = true;
            break;
          }
        }

        if (!countryFound) {
          if (place === '杜拜') countrySet.add('阿拉伯聯合大公國');
          else if (place === '留尼旺' || place === '法屬圭亞那') countrySet.add('法國');
          else countrySet.add(place);
        }
      });
      const totalCountries = countrySet.size;

      // Update Summary HTML
      document.getElementById('summary').innerHTML = `<h2>總計</h2><h3>到過 ${totalCountries} 個國家</h3><h3>到過 ${totalLocations} 個地點</h3>`;

      // Group places by year
      const placesByYear = {};
      travelData.forEach(item => {
        if (!placesByYear[item.year]) {
          placesByYear[item.year] = [];
        }
        placesByYear[item.year].push(item.place);
      });

      // Generate and inject HTML for yearly list
      const yearlyListDiv = document.getElementById('yearly-list');
      let yearlyHtml = '<h2>足跡列表</h2>';
      const sortedYears = Object.keys(placesByYear).sort((a, b) => b - a);

      sortedYears.forEach(year => {
        yearlyHtml += `<h3>${year}</h3><ul>`;
        const yearPlaces = [...new Set(placesByYear[year])];
        yearPlaces.forEach(place => {
          yearlyHtml += `<li>${place}</li>`;
        });
        yearlyHtml += '</ul>';
      });
      
      yearlyListDiv.innerHTML = yearlyHtml;
    }

    function geocodePlace(geocoder, map, item) {
      geocoder.geocode({ 'address': item.place }, (results, status) => {
        if (status === 'OK') {
          const marker = new google.maps.Marker({
            map: map,
            position: results[0].geometry.location,
          });
          const tooltip = document.getElementById('tooltip');

          marker.addListener('click', (e) => {
            // Close previously open tooltip if it's not the same marker
            if (currentOpenTooltip && currentOpenMarker !== marker) {
              currentOpenTooltip.style.display = 'none';
            }
            
            // Toggle current marker's tooltip
            if (tooltip.style.display === 'block') {
              tooltip.style.display = 'none';
              currentOpenTooltip = null;
              currentOpenMarker = null;
            } else {
              tooltip.innerHTML = `<strong>${item.year}</strong><br>${item.place}`;
              tooltip.style.display = 'block';
              tooltip.style.left = (e.domEvent.clientX + 15) + 'px';
              tooltip.style.top = (e.domEvent.clientY) + 'px';
              currentOpenTooltip = tooltip;
              currentOpenMarker = marker;
            }
          });

          // Optional: Keep mouseover/mouseout for desktop experience
          marker.addListener('mouseover', (e) => {
            if (currentOpenMarker !== marker) { // Only show if not already clicked
              tooltip.innerHTML = `<strong>${item.year}</strong><br>${item.place}`;
              tooltip.style.display = 'block';
              tooltip.style.left = (e.domEvent.clientX + 15) + 'px';
              tooltip.style.top = (e.domEvent.clientY) + 'px';
            }
          });

          marker.addListener('mouseout', () => {
            if (currentOpenMarker !== marker) { // Only hide if not clicked
              tooltip.style.display = 'none';
            }
          });

        } else {
          // Don't log error for now to avoid console spam for un-geocodable locations
          // console.error('Geocode was not successful for the following reason: ' + status);
        }
      });
    }

    // This is the callback function that Google Maps will call after it has loaded.
    function initMap() {
      initialize();
    }
  </script>
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAaXxK3Woq81fpxerQ3EFRMBc5bKmtQgO0&callback=initMap">
  </script>
</body>
</html>